# Memory Management

## Table of Contents

1. [Arena API](#arena-api)
2. [Cleanup App Resources](#cleanup-app-resources)

## Arena API

Ecewo uses [tsoding/arena](https://github.com/tsoding/arena) as arena allocator. But Ecewo provides its API with an abstraction layer for compatibility. Here are the macros that use arena approach:

```c
void *ecewo_alloc(req_or_res, size_t size);
void *ecewo_realloc(req_or_res, void *ptr, size_t oldsz, size_t newsz);
char *ecewo_strdup(req_or_res, const char *str);
void *ecewo_memdup(req_or_res, void *data, size_t size);
char *ecewo_sprintf(req_or_res, const char *format, ...);
```

> [!TIP]
> 
> We can give `req` or `res` as parameter. They both references the same arena, therefore both of them will work.

```c
void memory_example(Req *req, Res *res) {
    // Allocate memory (automatically freed after response)
    char *buffer = ecewo_alloc(req, 1024);
    
    // Duplicate string
    char *copy = ecewo_strdup(req, "original string");
    
    // Formatted string allocation
    char *formatted = ecewo_sprintf(req, "User %d has %s access", 
                                   123, "admin");
    
    // Memory duplication
    char data[] = "binary data";
    void *dup = ecewo_memdup(req, data, sizeof(data));
    
    // Reallocation
    char *new_buffer = ecewo_realloc(req, buffer, 1024, 2048);
    
    send_text(res, 200, formatted); // Send a response
}
```

> [!NOTE]
> 
> It's totally fine to use dynamic memory allocation functions that `stdlib.h` provides, but it's strongly recommended to use the allocator that Ecewo offers.


## Cleanup App Resources

Ecewo provides `shutdown_hook()` for one last cleanup right before shutting down the server. We can use it for such cases like saving critical data, completing pending transactions, closing database connections, final logs, cleaning up caches etc.

```c
// main.c

#include "handlers.h"
#include "db.h"
#include <stdio.h>

// User resources cleanup
void app_cleanup(void)
{
    db_close();
    redis_close();

    printf("App cleaned up\n");
}

int main(void)
{
    // Initialization of framework
    server_init(); // Will cleanup automatically

    // Initializations of app
    db_init();      // Will cleanup via db_close in shutdown hook
    redis_init();   // Will cleanup via redis_close in shutdown hook

    // Register app_cleanup function
    // It's going to work right before shutdown
    shutdown_hook(app_cleanup);

    if (server_listen(3000) != SERVER_OK)
    {
        fprintf(stderr, "Failed to start server\n");
        return 1;
    }

    server_run();
    return 0;
}
```

> [!IMPORTANT]
>
> Need to register `shutdown_hook()` right before `server_listen()`.
