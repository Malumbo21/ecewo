# Body

By default, ecewo buffers the entire request body in memory (up to 1MB) before calling the handler. Use `body_stream` middleware to process the body as it arrives. Body streaming is useful for large file uploads or when memory efficiency matters.

## Buffered Body (Default)

```c
void handler(Req *req, Res *res) {
  const char *body = req->body;
  size_t len = req->body_len;
  send_text(res, OK, "received");
}

post("/upload", handler);
```

## Streaming Body

Add `body_stream` middleware before your handler:
```c
void handler(Req *req, Res *res) {
  body_on_data(req, on_chunk);
  body_on_end(req, res, on_complete);
}

post("/upload", body_stream, handler);
```

---

## API

### `body_stream`
```c
void body_stream(Req *req, Res *res, Next next);
```

Middleware that enables streaming mode. Must be registered before the handler.

---

### `body_on_data`
```c
void body_on_data(Req *req, BodyDataCb callback);
```

Registers a callback to receive body chunks.
```c
typedef void (*BodyDataCb)(Req *req, const char *data, size_t len);
```

---

### `body_on_end`
```c
void body_on_end(Req *req, Res *res, BodyEndCb callback);
```

Registers a callback invoked when the full body has been received.
```c
typedef void (*BodyEndCb)(Req *req, Res *res);
```

---

### `body_limit`
```c
size_t body_limit(Req *req, size_t max_bytes);
```

Sets the maximum body size in bytes. Returns the previous limit. Default is 10MB in streaming mode, 1MB in buffered mode. Pass `0` to restore the default.
```c
void handler(Req *req, Res *res) {
  body_limit(req, 50 * 1024 * 1024); // 50MB
  body_on_data(req, on_chunk);
  body_on_end(req, res, on_complete);
}
```

---

## Example
```c
typedef struct {
  FILE *f;
  bool write_error;
} UploadCtx;

void on_chunk(Req *req, const char *data, size_t len) {
  UploadCtx *ctx = get_context(req, "upload");
  size_t written = fwrite(data, 1, len, ctx->f);
  if (written != len)
    ctx->write_error = true;
}

void on_complete(Req *req, Res *res) {
  UploadCtx *ctx = get_context(req, "upload");
  fclose(ctx->f);
  ctx->f = NULL;

  if (ctx->write_error) {
    send_text(res, INTERNAL_SERVER_ERROR, "Write failed");
    return;
  }

  send_text(res, OK, "Uploaded!");
}

void upload_handler(Req *req, Res *res) {
  UploadCtx *ctx = arena_alloc(req->arena, sizeof(UploadCtx));
  ctx->f = fopen("/tmp/upload.bin", "wb");
  ctx->write_error = false;

  if (!ctx->f) {
    send_text(res, INTERNAL_SERVER_ERROR, "Failed to open file");
    return;
  }

  set_context(req, "upload", ctx);
  body_limit(req, 100 * 1024 * 1024); // 100MB
  body_on_data(req, on_chunk);
  body_on_end(req, res, on_complete);
}

post("/upload", body_stream, upload_handler);
```

> [!NOTE]
>
> `FILE` is used just to show a body streaming example. You should use [`ecewo-fs`](https://github.com/ecewo/ecewo-fs) for file operations.
